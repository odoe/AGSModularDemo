(function(){define(["dojo/_base/declare","dojo/query","dojo/Evented","dijit/Menu","dijit/MenuBar","dijit/PopupMenuBarItem","widgets/legendtoc/LegendMenuItem","widgets/legendtoc/LegendCheckedMenuItem","widgets/legendtoc/CheckedPopupMenuItem","helpers/ArrayUtil"],function(a,b,c,d,e,f,g,h,i,j){var k=function(a,b,c){var e=new d({}),f=b.layerId||b.id;for(var h=0,i=c.length;h<i;h++){var j=c[h];e.addChild(new g({label:j.label.length>0?j.label:"...",legendUrl:[a.url,"/",f,"/images/",j.url].join("")}))}return e},l=function(a,b){var c=function(b){var c=a.visibleLayers,d=this.info.layerId||this.info.id,e=j.indexof(c,d);e>-1?c.splice(e,1):c[c.length]=d;var f=this.info.parentLayerId;e=j.indexof(c,f),!b&&f>-1&&e>-1?c.splice(e,1):b&&f>-1&&e>-1&&(c[c.length]=f);if(this.info.subLayerIds){var g=this.info.subLayerIds,h=!0;for(var i=0,k=g.length;i<k;i++){var l=g[i];e=j.indexof(c,l),e>-1?(c.splice(e,1),h=!1):(c[c.length]=l,h=!0)}h||(e=j.indexof(c,this.info.id),e>-1&&c.splice(e,1))}a.setVisibleLayers(c.length>0?c:[-1])};return function(e,f){var g=e.layers,l=[],m=function(a){for(var b=0,c=g.length;b<c;b++){var d=g[b];if(d.layerId===a)return d}return null},n=0;for(var o=0,p=a.layerInfos.length;o<p;o++){var q=a.layerInfos[o],r="",s,t=m(q.id);if(a.layerInfos[o].subLayerIds){var u=a.layerInfos[o].subLayerIds,v=new d({});for(var w=0,x=u.length;w<x;w++){var y=a.layerInfos[u[w]];l[l.length]=u[w],s=m(y.id),s&&(r=[a.url,"/",y.id,"/images/",s.legend[0].url].join(""),v.addChild(new h({label:s.layerName,info:y,legendUrl:r,checked:j.indexof(a.visibleLayers,s.layerId)>-1,onChange:c})))}b.addChild(new i({label:q.name,info:q,popup:v,checked:j.indexof(a.visibleLayers,q.id)>-1,onChange:c}))}else if(t&&t.legend.length>1&&l.indexOf(q.id)<0){s=m(q.id);if(s){var z=k(a,q,s.legend,b);b.addChild(new i({label:s.layerName,info:q,popup:z,checked:j.indexof(a.visibleLayers,s.layerId)>-1,onChange:c}))}}else l.indexOf(q.id)<0&&(s=m(q.id),s&&(r=[a.url,"/",q.id,"/images/",s.legend[0].url].join(""),b.addChild(new h({label:s.layerName,info:s,legendUrl:r,checked:j.indexof(a.visibleLayers,s.layerId)>-1,onChange:c}))))}}},m=a([c],{startup:function(a){var c=new d({}),g=function(a){this.layer.setVisibility(a)};for(var h=0,j=a.length;h<j;h++){var k=a[h],m=new d({}),n=esri.request({url:k.url+"/legend",content:{f:"json"},callbackParamName:"callback"});n.then(l(k,m));var o=new i({label:k.title,layer:k,checked:k.visible,popup:m,onChange:g});c.addChild(o)}var p=new e({});return p.addChild(new f({label:'<span class="icon-globe icon-white"></span> Layers',popup:c})),p.placeAt(b(".toc-menu")[0]),p.startup(),this}});return m})}).call(this)